<!DOCTYPE HTML>
<!--
	Industrious by TEMPLATED
	templated.co @templatedco
	Released for free under the Creative Commons Attribution 3.0 license (templated.co/license)
-->
<html>
	<head>
		<title>Lesson 1 "Hello World"</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		<meta name="description" content="" />
		<meta name="keywords" content="" />
		<link rel="stylesheet" href="../assets/layui/css/layui.css"  media="all">
		<link rel="stylesheet" href="../assets/css/main.css" />
		<link rel="stylesheet" href="https://codemirror.net/lib/codemirror.css">
		<link rel="stylesheet" href="https://codemirror.net/theme/darcula.css"/>
		<link rel="stylesheet" href="https://codemirror.net/addon/fold/foldgutter.css">
		
		<style>
			.CodeMirror.cm-s-darcula.CodeMirror-wrap{
				border-radius: 0.5rem;
			}
			.CodeMirror.cm-s-darcula.CodeMirror-wrap.CodeMirror-focused {
				border-color: #ce1b28;
				box-shadow: 0 0 0 3px #ce1b28; 
			}
		</style>
		
	</head>
	<body class="is-preload">

		<!-- Header -->
			<header id="header">
				<a class="logo" href="index.html">上科大搬砖社 - ShanghaiTech BrickThrough</a>
				<nav>
					<a href="#menu">目录</a>
				</nav>
			</header>

		<!-- Nav -->
			<nav id="menu">
				<ul class="links">
					<li><a href="index.html">主页</a></li>
					<li><a href="elements.html">Elements</a></li>
					<li><a href="generic.html">Generic</a></li>
				</ul>
			</nav>

		<!-- Heading -->
			<section id="heading">
				<div class="inner">
					<h1>Lesson 1</h1>
					<h1>"Hello World"</h1>
					<h3>From CS100 Summer Homework</h3>
				</div>
			</section>

		<!-- Content -->
			<section id="main" class="wrapper">
				<div class="inner">
					<div class="content">

						<!-- Form -->
						<h3>Code Test (Language: C)</h3>
							<div class="row gtr-uniform">
								
								<!-- Break -->
								<div class="col-12">
									<div class="codearea">
										<textarea name="textarea" id="textareaCode" rows="6"></textarea>
									</div>
								</div>
								<!-- Break -->
								<div class="col-12">
									<ul class="actions">
										<li><input type="submit" value="提交代码" class="primary" id="submitBTN" /></li>
									</ul>
								</div>
								<!-- Break -->
								<div class="col-12">
									<hr class="layui-bg-red">
									<h3>测试结果</h3>
									<table class="layui-hide" id="testResult"></table>
								</div>
							</div>
						
					</div>
				</div>
				
				<script src="https://codemirror.net/lib/codemirror.js"></script>
				<script src="https://codemirror.net/mode/clike/clike.js"></script>

				<script src="https://codemirror.net/addon/selection/active-line.js"></script>
				<script src="https://codemirror.net/addon/fold/foldcode.js"></script>
				<script src="https://codemirror.net/addon/fold/foldgutter.js"></script>
				<script src="https://codemirror.net/addon/fold/brace-fold.js"></script>
				<script src="https://codemirror.net/addon/fold/indent-fold.js"></script>

				<script src="../assets/layui/layui.js" charset="utf-8"></script>
				<script src="../assets/layui/form.js"></script>
				
				<script src="https://lib.sinaapp.com/js/jquery/1.9.1/jquery-1.9.1.min.js"></script>
				<script src="https://www.w3xue.com/tools/support/base64.min.js"></script>

				<script type="text/html" id="statusTpl">
					{{#  if(d.status === 'Accept'){ }}
						<span style="color: #449D54; font-weight:bold;">测试通过 Accept</span>
					{{#  } else if(d.status === 'Compile Error'){ }}
						<span style="color: #e8a60b; font-weight:bold;">编译错误 Compile Error</span>
					{{#  } else if(d.status === 'Runtime Error'){ }}
						<span style="color: #D04051; font-weight:bold;">运行错误 Runtime Error</span>
					{{#  } else if(d.status === 'Time Limit Exceeded'){ }}
						<span style="color: #D04051; font-weight:bold;">超出时间 Time Limit Exceeded</span>
					{{#  } else if(d.status === 'Wrong Answer'){ }}
						<span style="color: #D04051; font-weight:bold;">答案错误 Wrong Answer</span>
					{{#  } else if(d.status === 'Pre-Test Error'){ }}
						<span style="color: #AA38F5; font-weight:bold;">预检错误 Pre-Test Error</span>
					{{#  } }}
				</script>

				<script type="text/html" id="detailTpl">
					<a href="javascript:active['offset'].call('#detailButton', $('#detailButton'), {{d.detail}});" class="icon fa-search" id="detailButton"><span class="label">详情</span></a>
				</script>

				<script>						
					//触发事件
					var active = {
						offset: function(othis, detailID){
							var errorDetail = detail[detailID];
							var content = "";

							if (errorDetail.hasOwnProperty("id")) { // include input and expect
								for (const obj in testcases) {
									if (testcases[obj].id == errorDetail['id']) {
										content += '<div class="layui-card"><div class="layui-card-header"><span style="color: #449D54; font-weight:bold;">输入参数</span></div><div class="layui-card-body">'+testcases[obj].input+'</div></div>';
										content += '<div class="layui-card"><div class="layui-card-header"><span style="color: #449D54; font-weight:bold;">预期答案</span></div><div class="layui-card-body">'+testcases[obj].answer+'</div></div>';
										break;
									}
								}
							} 
							if (errorDetail.hasOwnProperty("error")) { // include error
								content += '<div class="layui-card"><div class="layui-card-header"><span style="color: #D04051; font-weight:bold;">发生错误</span></div><div class="layui-card-body">'+errorDetail['error']+'</div></div>';
							} 
							if (errorDetail.hasOwnProperty("wa")) { // include error
								content += '<div class="layui-card"><div class="layui-card-header"><span style="color: #D04051; font-weight:bold;">你的答案</span></div><div class="layui-card-body">'+errorDetail['wa']+'</div></div>';
							} 
							if (errorDetail.hasOwnProperty("ac")) { // include error
								content += '<div class="layui-card"><div class="layui-card-header"><span style="color: #449D54; font-weight:bold;">你的答案</span></div><div class="layui-card-body">'+errorDetail['ac']+'</div></div>';
							}
							
							layer.open({
								type: 1
								,area:["600px"]
								,title: '错误信息详情'
								,offset: 'auto' //具体配置参考：http://www.layui.com/doc/modules/layer.html#offset
								,id: 'layerDemo'+'auto' //防止重复弹出
								,content: '<div style="padding: 20px; background-color: #F2F2F2;">'+ content.replace(/\n/g, "<br>") +'</div>'
								,btn: '关闭'
								,btnAlign: 'c' //按钮居中
								,shade: 0 //不显示遮罩
								,yes: function(){
									layer.closeAll();
								}
							});
						}
					};
				</script>

				<script>
					var testcases = [{
						"id": "1001",
						"description": "Hello World!",
						"input": "",
						"answer": "Hello World!"
					}]

					var detail = []
					
					var table = new Table({id:'testcase'});
					table.initialize(function(tableObj){
						var col = [ //标题栏
								{field: 'id', title: 'ID', width: 80, sort: true}
								,{field: 'description', title: '测试用例', minWidth: 120}
								,{field: 'status', title: '状态', minWidth: 80, templet: '#statusTpl', sort: true}
								,{field: 'time', title: '提交时间', width: 160, sort: true}
								,{field: 'detail', title: '详情', templet: '#detailTpl', width: 80, align:'center'}
								]
						var ops = {
							elem: '#testResult'//自定义dom
							,id:'testcase'
							,data: []
							,cols: [col]
						}
						table.rederTable(ops,function () {
							});					
					})
				
					// //data为行数据json
					// table.updateRowItem(data,"id",function(data){
					// 	//默认更新完的回调
					// });

					var editor = CodeMirror.fromTextArea(document.getElementById("textareaCode"), {
						lineNumbers: true,
						lineWrapping:true,
						smartIndent: true,
						indentUnit: 4,
						indentWithTabs: true,
						foldGutter: true,
						gutters: ['CodeMirror-linenumbers', 'CodeMirror-foldgutter'],
						styleActiveLine: true,
						theme: "darcula",
						mode:  "text/x-csrc"
					});

					editor.setValue("#include <stdio.h>\n\nint main(void) { \n    // Warning: 'int main' is unchangeable! \n    // Otherwise it will cause Pre-Test Error.\n\n    // YOUR CODE HERE.\n    return 0;\n}");

					var apiurl = "https://runcode-api2-ng.dooccn.com";

					function getCurTime() {
						var myDate = new Date();
						var curTime = myDate.toLocaleDateString() + " " + myDate.getHours() + ":" + myDate.getMinutes() + ":" + myDate.getSeconds();
						return curTime;
					}

					function accept(id, detailID) {
						for (var obj in testcases) {
							if (testcases[obj].id == id) {
								var data = {
									"id": id
									,"description": testcases[obj].description
									,"time": getCurTime()
									,"status": "Accept"
									,"detail": detailID
								}
								table.addRowItem(data);
								break;
							}
						}						
					}

					function preTestError(detailID) {
						var data = {
							"id": '----'
							,"description": "'int main' is unchangeable and should be put at the beginning!"
							,"time": getCurTime()
							,"status": "Pre-Test Error"
							,"detail": detailID
						}
						table.addRowItem(data);		
					}

					function wrongAnswer(id, detailID) {
						for (var obj in testcases) {
							if (testcases[obj].id == id) {
								var data = {
									"id": id
									,"description": testcases[obj].description
									,"time": getCurTime()
									,"status": "Wrong Answer"
									,"detail": detailID
								}
								table.addRowItem(data);
								break;
							}
						}						
					}

					function runtimeError(id, detailID) {
						for (var obj in testcases) {
							if (testcases[obj].id == id) {
								var data = {
									"id": id
									,"description": testcases[obj].description
									,"time": getCurTime()
									,"status": "Runtime Error"
									,"detail": detailID
								}
								table.addRowItem(data);
								break;
							}
						}						
					}

					function timeLimitExceeded(id, detailID) {
						for (var obj in testcases) {
							if (testcases[obj].id == id) {
								var data = {
									"id": id
									,"description": testcases[obj].description
									,"time": getCurTime()
									,"status": "Time Limit Exceeded"
									,"detail": detailID
								}
								table.addRowItem(data);
								break;
							}
						}						
					}

					function compileError(detailID) {
						var data = {
							"id": "----"
							,"description": "Compile Error"
							,"time": getCurTime()
							,"status": "Compile Error"
							,"detail": detailID
						}
						table.addRowItem(data);				
					}

					btn = $("#submitBTN");
					btn.click(function() {
						btn[0].className = "primary disabled";
					
						code = editor.getValue();

						// TODO: processing the code.
						var headerNum = code.search('int main');
						if (headerNum == -1) {
							// Pre-Test Error: int main missing.
							var detailID = detail.push({
											"error": "'int main' missing.<br>'int main'缺失。"
										})
							preTestError(detailID-1);
							btn[0].className = "primary";
							return;
						}
						var header = code.slice(0, headerNum);

						var bodyNum = code.slice(headerNum).search('{');
						if (bodyNum == -1) {
							// Pre-Test Error: main function parentheses missing.
							var detailID = detail.push({
											"error": "main function parentheses missing.<br>main函数左括号 ' { ' 缺失。"
										})
							preTestError(detailID-1);
							btn[0].className = "primary";
							return;
						}
						var restPart = code.slice(headerNum).slice(bodyNum);
						var pcounter = 1;
						var currentPointer = 1;

						while (pcounter) {
							if (currentPointer == restPart.length){
								// Pre-Test Error: main function parentheses missing.
								var detailID = detail.push({
											"error": "main function parentheses missing.<br>main函数右括号 ' } ' 缺失。"
										})
								preTestError(detailID-1);
								btn[0].className = "primary";
								return;
							}

							if (restPart[currentPointer] == '{') {
								pcounter++;
							} else if (restPart[currentPointer] == '}') {
								pcounter--;
							}

							currentPointer++;
						}

						var body = restPart.slice(0, currentPointer);
						var rest = restPart.slice(currentPointer);

						// Add the test code.

						code = header + "\n#include <stdio.h>\n#include <unistd.h>\n#include <signal.h>\n#include <sys/types.h>\n#include <sys/wait.h>\n#include <sys/time.h>\nvoid handle(int sig)\n{\n    if (sig == SIGCHLD)\n    {\n        int pid;\n        int status;\n        while((pid = waitpid(-1, &status, WNOHANG)) > 0){}\n    }\n}\n\nint main(int argc, char **argv)\n{\n    int timeLimit = 1000000;\n    \n    pid_t pid;\n    int status;\n    \n    float time_use=0;\n struct timeval start;\n struct timeval end;//struct timezone tz; \n gettimeofday(&start,NULL); //gettimeofday(&start,&tz);\n \n \n    if(!(pid=fork()))\n"+
							   body   + "    else\n    {   int ret;\n        signal(SIGCHLD, handle);\n        \n        while(1){\n            gettimeofday(&end,NULL);\n      time_use=(end.tv_sec-start.tv_sec)*1000000+(end.tv_usec-start.tv_usec);\n      \n      ret = kill(pid,0);\n            if (ret == 0) { // Child process is alive.\n                \n                if(time_use>=timeLimit) { // over the time limit\n           printf(\"Time Limit Exceeded\");\n           kill(pid, 6);\n                    break;\n          }\n                \n            } else {\n                break;\n            }      \n        }  \n    }\n    return 0;\n}\n"+
							   rest;

						code = Base64.encode(code);
						stdin = '';
						runcode = 7; // C
						$.post( apiurl + "/compile2", {code:code,stdin:stdin,language:runcode} ,function(data, error, xhr){
							var output = data.output.replace("\r\n\r\n官方网站:http://www.dooccn.com",'').trim();
							var answer = testcases[0].answer;
							var id = "1001";
							if (output == "Compilation Failed") {
								var detailID = detail.push({
											"error": "NOTE: The line number is NOT correct (but similar)!<br><br>" + data.errors
										})
								compileError(detailID-1);
							} else if (data.errors) {
								var detailID = detail.push({
											"id": "1001",
											"error": "NOTE: The line number is NOT correct (but similar)!<br><br>" + data.errors
										})
								runtimeError(id, detailID-1);
							} else if (output == "Time Limit Exceeded") {
								var detailID = detail.push({
											"id": "1001",
											"error": "The time limit is 1s."
										})
								timeLimitExceeded(id, detailID-1);
							} else if (output == answer) {
								var detailID = detail.push({
											"id": "1001",
											"ac": output
										})
								accept(id, detailID-1);
							} else {
								var detailID = detail.push({
											"id": "1001",
											"wa": output
										})
								wrongAnswer(id, detailID-1);
							}
						});
						setTimeout(function(){
							btn[0].className = "primary";
						}, 10*1000);
					});
				</script>
			</section>
		
		<!-- Contact & Donate -->
			<section id="cta" class="wrapper">
				<div class="inner">
					<header class="special">
						<h2>有话想说？</h2>
						<ul class="actions special">
							<a href="#" class="button primary disabled">联系我们</a>
						</ul>
					</header>
				</div>
			</section>
		

		<!-- Footer -->
			<footer id="footer">
				<div class="inner">
					<div class="content">
						<section>
							<h3>关于我们</h3>
							<p>上海科技大学搬砖社（ShanghaiTechBrickThrough）是一个致力于翻译搬运英文高质量学术视频的学生组织。社团成立于2019年暑期，距离专业学术搬运二十年还有二十年。我们的发展愿景是打造一个集半公开翻译、学习教育、专业视频搬运为一体的综合学术平台。在做在线课程搬运工作的同时，我们也希望从多维度帮助同学们更方便、更高效地学习。我们期待看到您的Break Through！</p>
						</section>
						<section>
							<h4>快速访问</h4>
							<ul class="alt">
								<li><a href="http://www.shanghaitech.edu.cn/">上海科技大学</a></li>
							</ul>
						</section>
						<section>
							<h4>联系方式</h4>
							<ul class="plain">
								<li><a href="mailto:zhoual@shanghaitech.edu.cn"><i class="icon fa-envelope-o">&nbsp;</i>E-mail</a></li>
								<li><a href="https://github.com/stubrickthrough"><i class="icon fa-github">&nbsp;</i>Github</a></li>
								<li><a href="https://space.bilibili.com/438060628"><i class="icon fa-video-camera">&nbsp;</i>Bilibili</a></li>
								<li><a href="http://wpa.qq.com/msgrd?v=3&uin=1132482282&site=qq&menu=yes"><i class="icon fa-qq">&nbsp;</i>QQ</a></li>
							</ul>
						</section>
					</div>
					<div class="copyright">
						&copy; 2019 ShanghaiTech BrickThrough. Website support <a href="https://templated.co/">Templated</a>. Picture from <a href="http://www.shanghaitech.edu.cn/mlxy/list.htm">ShanghaiTech</a>. Logo by 林希越. All rights reserved.
					</div>
				</div>
			</footer>

		<!-- Scripts -->
			<script src="../assets/js/jquery.min.js"></script>
			<script src="../assets/js/browser.min.js"></script>
			<script src="../assets/js/breakpoints.min.js"></script>
			<script src="../assets/js/util.js"></script>
			<script src="../assets/js/main.js"></script>

	</body>
</html>